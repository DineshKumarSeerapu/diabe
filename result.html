{% extends "base.html" %}

{% block title %}Risk Assessment Results - DiabetesPredict Pro{% endblock %}

{% block content %}
<style>
/* Additional styles for result page */
.result-card {
    text-align: center;
    padding: 2rem;
    margin: 2rem 0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.result-positive {
    background: linear-gradient(135deg, #fff5f5, #fed7d7);
    border: 2px solid #e53e3e;
}

.result-negative {
    background: linear-gradient(135deg, #f0fff4, #c6f6d5);
    border: 2px solid #38a169;
}

.result-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.result-title {
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.probability-display {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.probability-bar {
    width: 100%;
    height: 20px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.probability-fill {
    height: 100%;
    transition: width 0.5s ease;
    border-radius: 10px;
}

.probability-low {
    background: linear-gradient(90deg, #48bb78, #68d391);
}

.probability-medium {
    background: linear-gradient(90deg, #ed8936, #f6ad55);
}

.probability-high {
    background: linear-gradient(90deg, #e53e3e, #fc8181);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-danger {
    background-color: #e53e3e;
    color: white;
}

.badge-success {
    background-color: #38a169;
    color: white;
}

.badge-info {
    background-color: #3182ce;
    color: white;
}

.text-danger {
    color: #e53e3e !important;
}

.text-success {
    color: #38a169 !important;
}

.text-warning {
    color: #d69e2e !important;
}

.text-muted {
    color: #718096 !important;
}

.mb-2 {
    margin-bottom: 0.5rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.d-flex {
    display: flex;
}

.justify-content-between {
    justify-content: space-between;
}

.align-items-center {
    align-items: center;
}

.list-unstyled {
    list-style: none;
    padding-left: 0;
}

/* Responsive grid */
.assessment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

@media (max-width: 768px) {
    .assessment-grid {
        grid-template-columns: 1fr;
    }
    
    .result-card {
        padding: 1rem;
    }
    
    .result-icon {
        font-size: 3rem;
    }
}
</style>

<div class="card result-card" id="result-card">
    <div class="result-icon">
        <span id="result-icon">✅</span>
    </div>
    
    <h2 class="result-title" id="result-title">
        Low Diabetes Risk
    </h2>
    
    <div class="probability-display">
        Risk Probability: <strong id="probability-display">0.0%</strong>
    </div>
    
    <div class="probability-bar">
        <div class="probability-fill" id="probability-fill" style="width: 0%;"></div>
    </div>
    
    <div id="recommendations-section">
        <!-- Recommendations will be populated by JavaScript -->
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Your Assessment Summary</h3>
    </div>
    <div class="assessment-grid">
        <div>
            <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Input Parameters</h4>
            <table style="width: 100%; font-size: 0.9rem;" id="input-parameters-table">
                <!-- Will be populated by JavaScript -->
            </table>
        </div>
        
        <div>
            <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Risk Factors Analysis</h4>
            <div id="risk-factors-section">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
    <a href="{{ url_for('predict') }}" class="btn btn-primary">
        <i class="fas fa-redo"></i> New PIMA Assessment
    </a>
    <a href="{{ url_for('predict_enhanced') }}" class="btn btn-secondary">
        <i class="fas fa-chart-area"></i> Enhanced DDFH Assessment
    </a>
    <a href="{{ url_for('models_status') }}" class="btn btn-info">
        <i class="fas fa-cogs"></i> Model Status
    </a>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <i class="fas fa-home"></i> Home
    </a>
</div>

<!-- XAI Explanations Section -->
{% if xai_available and explanations %}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-brain"></i> AI Explanation</h3>
        <small class="text-muted">Understanding how the AI made this prediction</small>
    </div>
    <div class="card-body">
        <!-- SHAP Summary (FastEDL XAI Format) -->
        {% if explanations and explanations.shap and explanations.shap.values and explanations.feature_names %}
        <div class="mb-4">
            <h5><i class="fas fa-chart-bar"></i> SHAP Analysis</h5>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
                <div>
                    <p class="text-muted">Key factors influencing this prediction:</p>
                    <ul class="list-unstyled">
                        {% for i in range(explanations.feature_names|length) %}
                        {% set feature = explanations.feature_names[i] %}
                        {% set shap_val = explanations.shap.values[i] if explanations.shap.values is iterable else 0 %}
                        {% if loop.index <= 5 %}
                        <li class="mb-2">
                            <strong>{{ feature }}:</strong> 
                            <span class="badge {% if shap_val > 0 %}badge-danger{% else %}badge-success{% endif %}">
                                {{ "%.3f"|format(shap_val) }}
                            </span>
                            {% if shap_val > 0 %}
                                <i class="fas fa-arrow-up text-danger"></i> Increases risk
                            {% else %}
                                <i class="fas fa-arrow-down text-success"></i> Decreases risk
                            {% endif %}
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                <div>
                    {% if explanations.shap.visualizations and explanations.shap.visualizations.bar %}
                    <div id="shap-mini-chart" style="min-height: 200px;"></div>
                    {% else %}
                    <div style="padding: 2rem; text-align: center; color: #718096; background: #f7fafc; border-radius: 8px;">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Chart visualization not available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% elif explanations and explanations.shap and explanations.shap.error %}
        <div class="mb-4">
            <h5><i class="fas fa-chart-bar"></i> SHAP Analysis</h5>
            <div style="padding: 1rem; background: #fed7d7; border-radius: 8px; color: #c53030;">
                <i class="fas fa-exclamation-triangle"></i> SHAP analysis unavailable: {{ explanations.shap.error }}
            </div>
        </div>
        {% endif %}

        <!-- LIME Summary (FastEDL XAI Format) -->
        {% if explanations and explanations.lime and explanations.lime.explanations %}
        <div class="mb-4">
            <h5><i class="fas fa-search"></i> LIME Analysis</h5>
            <p class="text-muted">Local explanation for this specific case:</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                {% for explanation in explanations.lime.explanations[:5] %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center" style="padding: 0.5rem; background: #f7fafc; border-radius: 6px;">
                        <span><strong>{{ explanation.feature }}</strong></span>
                        <span class="badge {% if explanation.importance > 0 %}badge-danger{% else %}badge-success{% endif %}">
                            {{ explanation.impact|title }}
                        </span>
                    </div>
                    <small class="text-muted">{{ explanation.explanation }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif explanations and explanations.lime and explanations.lime.error %}
        <div class="mb-4">
            <h5><i class="fas fa-search"></i> LIME Analysis</h5>
            <div style="padding: 1rem; background: #fed7d7; border-radius: 8px; color: #c53030;">
                <i class="fas fa-exclamation-triangle"></i> LIME analysis unavailable: {{ explanations.lime.error }}
            </div>
        </div>
        {% endif %}

        <!-- Medical Interpretation (FastEDL XAI) -->
        {% if explanations and explanations.medical_interpretation %}
        <div class="mb-4">
            <h5><i class="fas fa-stethoscope"></i> Medical Interpretation</h5>
            <div class="alert alert-info">
                <strong>{{ explanations.medical_interpretation.clinical_summary }}</strong>
                {% if explanations.medical_interpretation.high_risk_factors %}
                <div class="mt-2">
                    <strong>High Risk Factors:</strong>
                    <ul>
                        {% for factor in explanations.medical_interpretation.high_risk_factors %}
                        <li>{{ factor }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Recommendations (FastEDL XAI) -->
        {% if explanations and explanations.recommendations %}
        <div class="mb-4">
            <h5><i class="fas fa-lightbulb"></i> AI Recommendations</h5>
            {% for rec in explanations.recommendations[:3] %}
            <div class="alert alert-{{ 'danger' if rec.priority == 'High' else 'warning' if rec.priority == 'Medium' else 'info' }}" style="margin-bottom: 0.5rem;">
                <strong>{{ rec.category }} ({{ rec.priority }} Priority):</strong> {{ rec.recommendation }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="text-center">
            <a href="#" onclick="showFullExplanation()" class="btn btn-outline-info">
                <i class="fas fa-expand"></i> View Detailed Explanation
            </a>
        </div>
    </div>
</div>
{% elif xai_available %}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-brain"></i> AI Explanation</h3>
        <small class="text-muted">Understanding how the AI made this prediction</small>
    </div>
    <div class="card-body">
        <div style="padding: 2rem; text-align: center; color: #718096; background: #f7fafc; border-radius: 8px;">
            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>AI explanations are being generated. This may take a moment...</p>
            <button onclick="getExplanation()" class="btn btn-info">
                <i class="fas fa-brain"></i> Generate Explanation
            </button>
        </div>
    </div>
</div>
{% endif %}

<div class="card" style="margin-top: 2rem;">
    <div style="background: linear-gradient(135deg, #fff5f5, #fed7d7); padding: 2rem; border-radius: 12px; text-align: center;">
        <h3 style="color: var(--danger-color); margin-bottom: 1rem;">
            <i class="fas fa-user-md"></i> Important Medical Disclaimer
        </h3>
        <p style="margin-bottom: 1rem; color: var(--text-primary);">
            This assessment is for <strong>educational purposes only</strong> and should not replace professional medical diagnosis or treatment.
        </p>
        <p style="margin: 0; color: var(--text-primary);">
            Always consult with qualified healthcare professionals for medical advice, diagnosis, and treatment of diabetes or any health condition.
        </p>
    </div>
</div>

<!-- Plotly.js for visualizations -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- Data from Flask template -->
<script type="application/json" id="prediction-data">
{
    "prediction": {{ result.prediction|default(0) }},
    "probability": {{ result.probability|default(0.0) }},
    "inputData": {{ result.input_data|default('{}')|safe }},
    "predictionId": {{ prediction_id|default(0) }},
    "xaiAvailable": {{ xai_available|default(false)|lower }},
    "explanations": {{ explanations|default('null')|safe }},
    "riskLevel": "{{ result.risk_level|default('Unknown') }}",
    "className": "{{ result.class_name|default('') }}",
    "modelUsed": "{{ result.model_used|default('') }}",
    "confidence": {{ result.confidence|default(0.5) }},
    "predictionType": "{{ result.prediction_type|default('pima') }}"
}
</script>

<script>
// Load data from JSON script tag
var predictionData = JSON.parse(document.getElementById('prediction-data').textContent);

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    updateResultDisplay();
    populateInputParameters();
    populateRiskFactors();
    animateProbabilityBar();
    renderShapChart();
    setupButtonHandlers();
});

function updateResultDisplay() {
    var resultCard = document.getElementById('result-card');
    var resultIcon = document.getElementById('result-icon');
    var resultTitle = document.getElementById('result-title');
    var probabilityDisplay = document.getElementById('probability-display');
    var probabilityFill = document.getElementById('probability-fill');
    var recommendationsSection = document.getElementById('recommendations-section');
    
    var prediction = predictionData.prediction;
    var probability = predictionData.probability || predictionData.confidence;
    var riskLevel = predictionData.riskLevel;
    var className = predictionData.className;
    
    // Update probability display
    probabilityDisplay.textContent = (probability * 100).toFixed(1) + '%';
    
    // Update result card styling based on risk level
    if (riskLevel === 'High' || prediction === 2 || (prediction === 1 && predictionData.predictionType === 'pima')) {
        resultCard.className = 'card result-card result-positive';
        resultIcon.textContent = '⚠️';
        resultTitle.textContent = className ? className : 'High Diabetes Risk Detected';
        probabilityFill.className = 'probability-fill probability-high';
        
        // High risk recommendations
        recommendationsSection.innerHTML = 
            '<div style="background: rgba(229, 62, 62, 0.1); padding: 2rem; border-radius: 12px; margin: 2rem 0;">' +
            '<h3 style="color: var(--error-color); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Immediate Actions Recommended</h3>' +
            '<ul style="text-align: left; color: var(--text-primary);">' +
            '<li><strong>Consult a healthcare professional immediately</strong> for proper diagnosis and treatment</li>' +
            '<li>Schedule blood glucose and HbA1c testing</li>' +
            '<li>Begin monitoring your diet and reduce sugar intake</li>' +
            '<li>Increase physical activity and exercise regularly</li>' +
            '<li>Monitor your weight and blood pressure</li>' +
            '</ul></div>';
    } else if (riskLevel === 'Moderate' || prediction === 1) {
        resultCard.className = 'card result-card';
        resultCard.style.border = '2px solid var(--warning-color)';
        resultCard.style.background = 'linear-gradient(135deg, #fefcbf, #fef08a)';
        resultIcon.textContent = '⚡';
        resultTitle.textContent = className ? className : 'Moderate Diabetes Risk';
        probabilityFill.className = 'probability-fill probability-medium';
        
        // Moderate risk recommendations
        recommendationsSection.innerHTML = 
            '<div style="background: rgba(237, 137, 54, 0.1); padding: 2rem; border-radius: 12px; margin: 2rem 0;">' +
            '<h3 style="color: var(--warning-color); margin-bottom: 1rem;"><i class="fas fa-exclamation"></i> Prevention Actions Recommended</h3>' +
            '<ul style="text-align: left; color: var(--text-primary);">' +
            '<li>Schedule a health check-up within 3-6 months</li>' +
            '<li>Focus on lifestyle modifications</li>' +
            '<li>Monitor blood sugar levels periodically</li>' +
            '<li>Maintain a healthy diet and exercise routine</li>' +
            '<li>Consider dietary consultation</li>' +
            '</ul></div>';
    } else {
        resultCard.className = 'card result-card result-negative';
        resultIcon.textContent = '✅';
        resultTitle.textContent = className ? className : 'Low Diabetes Risk';
        
        if (probability < 0.3) {
            probabilityFill.className = 'probability-fill probability-low';
        } else if (probability < 0.7) {
            probabilityFill.className = 'probability-fill probability-medium';
        } else {
            probabilityFill.className = 'probability-fill probability-high';
        }
        
        // Low risk recommendations
        recommendationsSection.innerHTML = 
            '<div style="background: rgba(56, 161, 105, 0.1); padding: 2rem; border-radius: 12px; margin: 2rem 0;">' +
            '<h3 style="color: var(--success-color); margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Prevention Recommendations</h3>' +
            '<ul style="text-align: left; color: var(--text-primary);">' +
            '<li>Continue maintaining a healthy lifestyle</li>' +
            '<li>Regular exercise and balanced diet</li>' +
            '<li>Annual health check-ups including glucose testing</li>' +
            '<li>Monitor your weight and BMI</li>' +
            '<li>Stay informed about diabetes prevention</li>' +
            '</ul></div>';
    }
}

function populateInputParameters() {
    var table = document.getElementById('input-parameters-table');
    var data = predictionData.inputData;
    
    if (!data || typeof data !== 'object') {
        table.innerHTML = '<tr><td colspan="2">No input data available</td></tr>';
        return;
    }
    
    var html = '';
    
    // Handle different input formats based on prediction type
    if (predictionData.predictionType === 'pima' || data.pregnancies !== undefined) {
        // PIMA format
        html += '<tr><td><strong>Pregnancies:</strong></td><td>' + (data.pregnancies || 0) + '</td></tr>';
        html += '<tr><td><strong>Glucose:</strong></td><td>' + (data.glucose || 0) + ' mg/dL</td></tr>';
        html += '<tr><td><strong>Blood Pressure:</strong></td><td>' + (data.blood_pressure || 0) + ' mmHg</td></tr>';
        html += '<tr><td><strong>Skin Thickness:</strong></td><td>' + (data.skin_thickness || 0) + ' mm</td></tr>';
        html += '<tr><td><strong>Insulin:</strong></td><td>' + (data.insulin || 0) + ' mu U/ml</td></tr>';
        html += '<tr><td><strong>BMI:</strong></td><td>' + (data.bmi ? data.bmi.toFixed(1) : '0.0') + '</td></tr>';
        html += '<tr><td><strong>Diabetes Pedigree:</strong></td><td>' + (data.diabetes_pedigree ? data.diabetes_pedigree.toFixed(3) : '0.000') + '</td></tr>';
        html += '<tr><td><strong>Age:</strong></td><td>' + (data.age || 0) + ' years</td></tr>';
    } else {
        // DDFH format or generic format
        for (var key in data) {
            if (data.hasOwnProperty(key)) {
                var label = key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ');
                var value = data[key];
                
                // Format specific values
                if (key === 'bmi' || key === 'hba1c' || key === 'tg') {
                    value = typeof value === 'number' ? value.toFixed(1) : value;
                }
                
                html += '<tr><td><strong>' + label + ':</strong></td><td>' + value + '</td></tr>';
            }
        }
    }
    
    table.innerHTML = html;
}

function populateRiskFactors() {
    var section = document.getElementById('risk-factors-section');
    var data = predictionData.inputData;
    
    if (!data || typeof data !== 'object') {
        section.innerHTML = '<p>Risk analysis not available</p>';
        return;
    }
    
    var html = '';
    
    // Check for different risk factors based on available data
    if (data.glucose) {
        var highGlucose = data.glucose > 140;
        html += '<div style="margin-bottom: 1rem;">' +
            '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">' +
            '<span style="color: ' + (highGlucose ? 'var(--error-color)' : 'var(--success-color)') + ';">' +
            '<i class="fas ' + (highGlucose ? 'fa-exclamation-triangle' : 'fa-check') + '"></i></span>' +
            '<span style="margin-left: 0.5rem;">Glucose Level</span></div>' +
            '<div style="font-size: 0.8rem; color: var(--text-secondary);">' +
            (highGlucose ? 'High glucose level detected (>' + data.glucose + ' mg/dL)' : 'Normal glucose level (' + data.glucose + ' mg/dL)') +
            '</div></div>';
    }
    
    if (data.bmi) {
        var highBmi = data.bmi > 30;
        html += '<div style="margin-bottom: 1rem;">' +
            '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">' +
            '<span style="color: ' + (highBmi ? 'var(--error-color)' : 'var(--success-color)') + ';">' +
            '<i class="fas ' + (highBmi ? 'fa-exclamation-triangle' : 'fa-check') + '"></i></span>' +
            '<span style="margin-left: 0.5rem;">Body Mass Index</span></div>' +
            '<div style="font-size: 0.8rem; color: var(--text-secondary);">' +
            (highBmi ? 'BMI indicates obesity (>' + data.bmi + ')' : 
             data.bmi > 25 ? 'BMI indicates overweight (' + data.bmi + ')' : 'Normal BMI (' + data.bmi + ')') +
            '</div></div>';
    }
    
    if (data.hba1c) {
        var highHbA1c = data.hba1c >= 6.5;
        var preHbA1c = data.hba1c >= 5.7;
        html += '<div style="margin-bottom: 1rem;">' +
            '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">' +
            '<span style="color: ' + (highHbA1c ? 'var(--error-color)' : preHbA1c ? 'var(--warning-color)' : 'var(--success-color)') + ';">' +
            '<i class="fas ' + (highHbA1c ? 'fa-exclamation-triangle' : preHbA1c ? 'fa-exclamation' : 'fa-check') + '"></i></span>' +
            '<span style="margin-left: 0.5rem;">HbA1c Level</span></div>' +
            '<div style="font-size: 0.8rem; color: var(--text-secondary);">' +
            (highHbA1c ? 'Diabetic range (≥6.5%)' : preHbA1c ? 'Pre-diabetic range (5.7-6.4%)' : 'Normal range (<5.7%)') +
            '</div></div>';
    }
    
    if (data.blood_pressure) {
        var highBp = data.blood_pressure > 90;
        html += '<div style="margin-bottom: 1rem;">' +
            '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">' +
            '<span style="color: ' + (highBp ? 'var(--error-color)' : 'var(--success-color)') + ';">' +
            '<i class="fas ' + (highBp ? 'fa-exclamation-triangle' : 'fa-check') + '"></i></span>' +
            '<span style="margin-left: 0.5rem;">Blood Pressure</span></div>' +
            '<div style="font-size: 0.8rem; color: var(--text-secondary);">' +
            (highBp ? 'High blood pressure (>' + data.blood_pressure + ' mmHg)' : 'Normal blood pressure (' + data.blood_pressure + ' mmHg)') +
            '</div></div>';
    }
    
    if (data.age) {
        var oldAge = data.age > 45;
        html += '<div style="margin-bottom: 1rem;">' +
            '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">' +
            '<span style="color: ' + (oldAge ? 'var(--warning-color)' : 'var(--success-color)') + ';">' +
            '<i class="fas ' + (oldAge ? 'fa-clock' : 'fa-check') + '"></i></span>' +
            '<span style="margin-left: 0.5rem;">Age Factor</span></div>' +
            '<div style="font-size: 0.8rem; color: var(--text-secondary);">' +
            (oldAge ? 'Age >' + data.age + ' increases diabetes risk' : 'Age ' + data.age + ' within lower risk range') +
            '</div></div>';
    }
    
    section.innerHTML = html || '<p>No risk factors to analyze</p>';
}

function animateProbabilityBar() {
    var probabilityFill = document.getElementById('probability-fill');
    if (probabilityFill) {
        var targetWidth = (predictionData.probability * 100) + '%';
        probabilityFill.style.width = '0%';
        setTimeout(function() {
            probabilityFill.style.width = targetWidth;
        }, 500);
    }
}

function renderShapChart() {
    if (predictionData.explanations && predictionData.explanations.shap && 
        predictionData.explanations.shap.visualizations && predictionData.explanations.shap.visualizations.bar) {
        try {
            if (typeof Plotly !== 'undefined') {
                var miniChartData = predictionData.explanations.shap.visualizations.bar;
                if (miniChartData && miniChartData.data && miniChartData.layout) {
                    var miniLayout = Object.assign({}, miniChartData.layout, {
                        height: 200,
                        margin: {l: 50, r: 20, t: 20, b: 50},
                        responsive: true
                    });
                    Plotly.newPlot('shap-mini-chart', miniChartData.data, miniLayout, {responsive: true});
                }
            } else {
                console.warn('Plotly not loaded');
            }
        } catch (error) {
            console.error('Error rendering SHAP chart:', error);
            var chartContainer = document.getElementById('shap-mini-chart');
            if (chartContainer) {
                chartContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #718096;"><i class="fas fa-exclamation-triangle"></i><br>Chart rendering failed</div>';
            }
        }
    }
}

function setupButtonHandlers() {
    var buttons = document.querySelectorAll('.btn');
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function(e) {
            if (this.classList.contains('btn-info') || this.classList.contains('btn-outline-info')) {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                this.disabled = true;
            }
        });
    }
}

function getExplanation() {
    try {
        if (predictionData.predictionId) {
            window.location.href = '/explain/' + predictionData.predictionId;
        } else {
            window.location.href = '/';
        }
    } catch (error) {
        console.error('Error navigating to explanation:', error);
        alert('Error loading explanation. Please try again.');
    }
}

function showFullExplanation() {
    getExplanation();
}

window.addEventListener('error', function(e) {
    console.error('JavaScript error:', e.error);
});

function handleResize() {
    var chartContainer = document.getElementById('shap-mini-chart');
    if (chartContainer && typeof Plotly !== 'undefined') {
        Plotly.Plots.resize(chartContainer);
    }
}

window.addEventListener('resize', handleResize);
</script>
{% endblock %}